{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<main class="space-y-8">
    <!-- Header Actions -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <a href="{{ url_for('manage_cases') }}" class="card p-6 flex flex-col items-center justify-center text-center hover:bg-slate-800/50 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 mb-2 text-slate-400"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
            <h2 class="font-semibold text-lg">Manage My Cases</h2>
            <p class="text-sm text-slate-400">Add, edit, or view cases you've reported.</p>
        </a>
        <a href="{{ url_for('analyze_sighting') }}" class="card p-6 flex flex-col items-center justify-center text-center hover:bg-slate-800/50 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 mb-2 text-slate-400"><path d="M10 12.5 8 15l2 2.5"/><path d="m14 12.5 2 2.5-2 2.5"/><path d="M12 2a10 10 0 0 0-9.3 14.2c0 2.4 1.4 4.5 3.5 5.5.9.4 1.3-.1 1.3-.4 0-.3 0-1.2 0-2.3-1.4.3-1.7-1-1.7-1-.3-.8-.8-1-.8-1-.7-.5.1-.5.1-.5.8.1 1.2.8 1.2.8.7 1.2 1.9 1 2.4.7.1-.6.3-1 .5-1.2-1.8-.2-3.7-1-3.7-4 0-.9.3-1.6.8-2.2-.1-.2-.4-1 .1-2.1 0 0 .7-.2 2.2.8.6-.2 1.3-.3 2-.3s1.4.1 2 .3c1.5-1 2.2-.8 2.2-.8.4 1.1.2 1.9.1 2.1.5.6.8 1.3.8 2.2 0 3-1.9 3.8-3.7 4 .3.3.6.8.6 1.5 0 1.1 0 2 0 2.3 0 .3.4.8 1.3.4 2.1-1 3.5-3.1 3.5-5.5A10 10 0 0 0 12 2Z"/></svg>
            <h2 class="font-semibold text-lg">Analyze a Sighting</h2>
            <p class="text-sm text-slate-400">Upload a photo to check for matches.</p>
        </a>
    </div>

    <!-- Tabs -->
    <div class="border-b border-slate-800">
        <nav class="-mb-px flex space-x-6" aria-label="Tabs">
            <button id="showMissingBtn" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-white border-white">
                Missing Cases
            </button>
            <button id="showFoundBtn" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-400 border-transparent hover:text-white hover:border-slate-300">
                Found Cases
            </button>
        </nav>
    </div>

    <!-- Cases Display Grid -->
    <div>
        <!-- Missing Cases -->
        <div id="missingCasesSection" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            {% if missing_cases %}
                {% for case in missing_cases %}
                <div class="card overflow-hidden group">
                    <a href="{{ url_for('case_detail', case_id=case.id) }}">
                        <img src="{{ case.photoURL }}" alt="{{ case.name }}" class="w-full h-64 object-cover group-hover:scale-105 transition-transform duration-300">
                    </a>
                    <div class="p-4">
                        <h3 class="font-semibold text-lg">{{ case.name }}</h3>
                        <p class="text-sm text-slate-400">Age: {{ case.age }}</p>
                        {% if case.cashReward and case.cashReward > 0 %}
                            <p class="text-sm font-bold text-green-400 mt-2">Reward: â‚¹{{ "{:,.0f}".format(case.cashReward) }}</p>
                        {% endif %}
                    </div>
                     <div class="p-4 border-t border-slate-800">
                        <button onclick="shareCase('{{ case.id }}')" class="btn-secondary w-full text-sm">Share Case</button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-span-full card text-center py-16">
                     <p class="text-slate-400">No active missing cases at the moment.</p>
                </div>
            {% endif %}
        </div>

        <!-- Found Cases -->
        <div id="foundCasesSection" class="hidden grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
             {% if found_cases %}
                {% for case in found_cases %}
                 <div class="card overflow-hidden group opacity-60">
                    <a href="{{ url_for('found_case_details', case_id=case.id) }}">
                        <img src="{{ case.photoURL }}" alt="{{ case.name }}" class="w-full h-64 object-cover">
                    </a>
                    <div class="p-4">
                        <h3 class="font-semibold text-lg">{{ case.name }}</h3>
                        <p class="text-sm text-slate-400">Status: <span class="text-green-400">Found</span></p>
                    </div>
                 </div>
                 {% endfor %}
            {% else %}
                 <div class="col-span-full card text-center py-16">
                     <p class="text-slate-400">No cases have been marked as found yet.</p>
                </div>
            {% endif %}
        </div>
    </div>
</main>
{% endblock %}
{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    const showMissingBtn = document.getElementById('showMissingBtn');
    const showFoundBtn = document.getElementById('showFoundBtn');
    const missingCasesSection = document.getElementById('missingCasesSection');
    const foundCasesSection = document.getElementById('foundCasesSection');

    function setActiveTab(button) {
        [showMissingBtn, showFoundBtn].forEach(btn => {
            btn.classList.remove('text-white', 'border-white');
            btn.classList.add('text-slate-400', 'border-transparent');
        });
        button.classList.add('text-white', 'border-white');
        button.classList.remove('text-slate-400', 'border-transparent');
    }

    showMissingBtn.addEventListener('click', () => {
        missingCasesSection.classList.remove('hidden');
        foundCasesSection.classList.add('hidden');
        setActiveTab(showMissingBtn);
    });

    showFoundBtn.addEventListener('click', () => {
        missingCasesSection.classList.add('hidden');
        foundCasesSection.classList.remove('hidden');
        setActiveTab(showFoundBtn);
    });

    async function shareCase(caseId) {
        showAlert('Generating poster... please wait.', true);
        const iframe = document.createElement('iframe');
        iframe.src = `/case/${caseId}/poster`;
        iframe.style.position = 'absolute';
        iframe.style.left = '-9999px';
        document.body.appendChild(iframe);

        iframe.onload = () => {
            setTimeout(() => {
                const posterElement = iframe.contentWindow.document.getElementById('poster');
                if (!posterElement) {
                    showAlert('Error generating poster.', false);
                    document.body.removeChild(iframe);
                    return;
                }
                html2canvas(posterElement, { scale: 2, useCORS: true }).then(canvas => {
                    canvas.toBlob(async (blob) => {
                        const file = new File([blob], "missing-poster.png", { type: "image/png" });
                        const shareData = {
                            files: [file],
                            title: 'Missing Person Alert',
                            text: `Please help find this person. See poster for details.`
                        };
                        if (navigator.canShare && navigator.canShare(shareData)) {
                            try {
                                await navigator.share(shareData);
                            } catch (err) { console.error("Share failed:", err); }
                        } else {
                            showAlert('Web Share not supported. Downloading poster.', false);
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(blob);
                            link.download = 'missing-poster.png';
                            link.click();
                        }
                        document.body.removeChild(iframe);
                    }, 'image/png');
                });
            }, 1000); // Wait for poster to render
        };
    }
</script>
{% endblock %}

